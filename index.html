{% extends "base.html" %}
{% block content %}

<section class="hero card card--glass">
  <div class="hero__left">
    <h1 class="hero__title">–ê–Ω–∞–ª–∏–∑ —Ä—ã–Ω–∫–∞ –ø–æ–¥–µ—Ä–∂–∞–Ω–Ω—ã—Ö –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π</h1>
    <p class="hero__text">–§–∏–ª—å—Ç—Ä—ã + –ø–æ–∏—Å–∫ –ø–æ —Ç–µ–∫—Å—Ç—É –∏ –ø–æ–¥—Å–∫–∞–∑–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ä—è–¥–æ–º —Å –ø–æ–ª–µ–º.</p>
    <div class="chips">
      <span class="chip">–ü–æ–∏—Å–∫</span>
      <span class="chip">–§–∏–ª—å—Ç—Ä—ã</span>
      <span class="chip">–ì—Ä–∞—Ñ–∏–∫–∏</span>
      <span class="chip">–ò–∑–±—Ä–∞–Ω–Ω–æ–µ</span>
      <span class="chip">–≠–∫—Å–ø–æ—Ä—Ç CSV</span>
    </div>
  </div>

  <div class="hero__right">
    <div class="stat-grid">
      <div class="stat">
        <div class="stat__label">–í—Å–µ–≥–æ –∞–≤—Ç–æ</div>
        <div class="stat__value">{{ stats.total_cars }}</div>
      </div>
      <div class="stat">
        <div class="stat__label">–°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞</div>
        <div class="stat__value">{{ stats.mean_price }} $</div>
      </div>
      <div class="stat">
        <div class="stat__label">–ú–µ–¥–∏–∞–Ω–Ω–∞—è —Ü–µ–Ω–∞</div>
        <div class="stat__value">{{ stats.median_price }} $</div>
      </div>
    </div>
  </div>
</section>

<section class="grid-2">
  <div class="card">
    <div class="card__header">
      <h2 class="card__title">–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∏ –ø–æ–∏—Å–∫</h2>
      <p class="card__subtitle">–ü–æ–¥—Å–∫–∞–∑–∫–∏: –≤–≤–µ–¥–∏ 2+ —Å–∏–º–≤–æ–ª–∞ (–ø—Ä–∏–º–µ—Ä: ‚Äúaudi q5‚Äù, ‚Äúelectric awd‚Äù)</p>
    </div>

    <form method="get" action="{{ url_for('index') }}" class="form" id="filterForm">
      <div class="form__grid">

        <!-- –ü–û–ò–°–ö + –ñ–ò–í–´–ï –ü–û–î–°–ö–ê–ó–ö–ò -->
        <div class="field field--span2 search-field" id="searchField">
          <label class="field__label">–ü–æ–∏—Å–∫</label>

          <input
            class="input"
            id="searchInput"
            type="text"
            name="q"
            value="{{ filters.get('q','') }}"
            placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è –ø–æ–∏—Å–∫–∞..."
            autocomplete="off"
            spellcheck="false"
          >

          <!-- –û–∫–æ—à–∫–æ –ø–æ–¥—Å–∫–∞–∑–æ–∫ -->
          <div class="suggest" id="searchSuggest" hidden>
            <div class="suggest__head">
              <span>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã</span>
              <button type="button" class="suggest__close" id="suggestClose">√ó</button>
            </div>
            <div class="suggest__list" id="suggestList"></div>
          </div>
        </div>

        <div class="field">
          <label class="field__label">–ú–∞—Ä–∫–∞</label>
          <select class="input" name="brand" id="brandSelect">
            <option value="">–õ—é–±–∞—è</option>
            {% for b in brands %}
            <option value="{{ b }}" {% if filters.get('brand','') == b %}selected{% endif %}>{{ b }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="field">
          <label class="field__label">–ú–æ–¥–µ–ª—å</label>
          <select class="input" name="model" id="modelSelect">
            <option value="">–õ—é–±–∞—è</option>
          </select>
        </div>

        <div class="field">
          <label class="field__label">–¢–∏–ø –∫—É–∑–æ–≤–∞</label>
          <select class="input" name="body_type">
            <option value="">–õ—é–±–æ–π</option>
            {% for bt in body_types %}
            <option value="{{ bt }}" {% if filters.get('body_type','') == bt %}selected{% endif %}>{{ bt }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="field">
          <label class="field__label">–¢–æ–ø–ª–∏–≤–æ</label>
          <select class="input" name="fuel_type">
            <option value="">–õ—é–±–æ–µ</option>
            {% for f in fuel_types %}
            <option value="{{ f }}" {% if filters.get('fuel_type','') == f %}selected{% endif %}>{{ f }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="field">
          <label class="field__label">–ü—Ä–∏–≤–æ–¥</label>
          <select class="input" name="drive_type">
            <option value="">–õ—é–±–æ–π</option>
            {% for d in drive_types %}
            <option value="{{ d }}" {% if filters.get('drive_type','') == d %}selected{% endif %}>{{ d }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="field">
          <label class="field__label">–¢—Ä–∞–Ω—Å–º–∏—Å—Å–∏—è</label>
          <select class="input" name="transmission">
            <option value="">–õ—é–±–∞—è</option>
            {% for t in transmissions %}
            <option value="{{ t }}" {% if filters.get('transmission','') == t %}selected{% endif %}>{{ t }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="field">
          <label class="field__label">–ì–æ–¥ –æ—Ç</label>
          <input class="input" type="number" name="year_min" value="{{ filters.get('year_min','') }}">
        </div>

        <div class="field">
          <label class="field__label">–ì–æ–¥ –¥–æ</label>
          <input class="input" type="number" name="year_max" value="{{ filters.get('year_max','') }}">
        </div>

        <div class="field">
          <label class="field__label">–ú–æ—â–Ω–æ—Å—Ç—å –æ—Ç</label>
          <input class="input" type="number" name="hp_min" value="{{ filters.get('hp_min','') }}">
        </div>

        <div class="field">
          <label class="field__label">–ú–æ—â–Ω–æ—Å—Ç—å –¥–æ</label>
          <input class="input" type="number" name="hp_max" value="{{ filters.get('hp_max','') }}">
        </div>

        <div class="field">
          <label class="field__label">–¶–µ–Ω–∞ –æ—Ç ($)</label>
          <input class="input" type="number" name="price_min" value="{{ filters.get('price_min','') }}">
        </div>

        <div class="field">
          <label class="field__label">–¶–µ–Ω–∞ –¥–æ ($)</label>
          <input class="input" type="number" name="price_max" value="{{ filters.get('price_max','') }}">
        </div>
      </div>

      <div class="form__actions">
        <button class="btn btn-primary" type="submit">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
        <button class="btn btn-ghost" type="button" id="resetBtn">–°–±—Ä–æ—Å–∏—Ç—å</button>
      </div>
    </form>

    <div class="divider"></div>

    <h3 class="mini-title">–ü–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç—å –º–∞—Ä–æ–∫</h3>
    <div class="brand-list">
      {% for brand, count in stats.popular_brands.items() %}
      <div class="brand-item">
        <span class="brand-item__name">{{ brand }}</span>
        <span class="badge badge--soft">{{ count }}</span>
      </div>
      {% endfor %}
    </div>
  </div>

  <div class="card">
    <div class="card__header">
      <h2 class="card__title">–ì—Ä–∞—Ñ–∏–∫–∏</h2>
      <p class="card__subtitle">–ì—Ä–∞—Ñ–∏–∫–∏ –æ—Ç–¥–∞—é—Ç—Å—è –∫–∞–∫ PNG (–±–µ–∑ ‚Äúimage errors‚Äù)</p>
    </div>

    <div class="charts">
      <div class="chart-card">
        <div class="chart-card__top">
          <div class="chart-card__title">–°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞ –ø–æ –º–∞—Ä–∫–∞–º</div>
          <a class="link" target="_blank" href="{{ url_for('plot', name='brand_price') }}">–û—Ç–∫—Ä—ã—Ç—å</a>
        </div>
        <img class="chart-img" src="{{ url_for('plot', name='brand_price') }}" alt="brand_price">
      </div>

      <div class="chart-card">
        <div class="chart-card__top">
          <div class="chart-card__title">–¶–µ–Ω–∞ –æ—Ç –≥–æ–¥–∞ –≤—ã–ø—É—Å–∫–∞</div>
          <a class="link" target="_blank" href="{{ url_for('plot', name='price_year') }}">–û—Ç–∫—Ä—ã—Ç—å</a>
        </div>
        <img class="chart-img" src="{{ url_for('plot', name='price_year') }}" alt="price_year">
      </div>

      <div class="chart-card">
        <div class="chart-card__top">
          <div class="chart-card__title">–¶–µ–Ω–∞ –æ—Ç –º–æ—â–Ω–æ—Å—Ç–∏</div>
          <a class="link" target="_blank" href="{{ url_for('plot', name='price_hp') }}">–û—Ç–∫—Ä—ã—Ç—å</a>
        </div>
        <img class="chart-img" src="{{ url_for('plot', name='price_hp') }}" alt="price_hp">
      </div>
    </div>
  </div>
</section>

<section class="card">
  <div class="card__header">
    <h2 class="card__title">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã</h2>
    <p class="card__subtitle">–ù–∞–π–¥–µ–Ω–æ: <b>{{ cars|length }}</b></p>
  </div>

  <div class="table-actions">
    <a class="btn btn-secondary" id="exportLink" href="#">–≠–∫—Å–ø–æ—Ä—Ç CSV</a>
  </div>

  <div class="table-wrap">
    <table class="table">
      <thead>
        <tr>
          <th>–ú–∞—Ä–∫–∞</th><th>–ú–æ–¥–µ–ª—å</th><th>–ì–æ–¥</th><th>–ö—É–∑–æ–≤</th>
          <th>–ú–æ—â–Ω–æ—Å—Ç—å</th><th>–¢–æ–ø–ª–∏–≤–æ</th><th>–ü—Ä–∏–≤–æ–¥</th><th>–ö–ü–ü</th><th>–¶–µ–Ω–∞, $</th>
          <th class="th-actions">–î–µ–π—Å—Ç–≤–∏—è</th>
        </tr>
      </thead>
      <tbody>
        {% for car in cars %}
        <tr class="row-anim">
          <td><span class="pill">{{ car.brand }}</span></td>
          <td>{{ car.model }}</td>
          <td>{{ car.year }}</td>
          <td>{{ car.body_type }}</td>
          <td>{{ car.horsepower }}</td>
          <td>{{ car.fuel_type }}</td>
          <td>{{ car.drive_type }}</td>
          <td>{{ car.transmission }}</td>
          <td><b>{{ car.price_usd }}</b></td>
          <td class="actions">
            <a class="icon-btn {% if car.id in favorites %}icon-btn--active{% endif %}"
               title="–í –∏–∑–±—Ä–∞–Ω–Ω–æ–µ"
               href="{{ url_for('toggle_favorite', car_id=car.id, next=request.full_path) }}">
              {% if car.id in favorites %}‚òÖ{% else %}‚òÜ{% endif %}
            </a>

            <a class="btn btn-sm btn-outline" href="{{ url_for('recommend', car_id=car.id) }}">–ü–æ—Ö–æ–∂–∏–µ</a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  {% if cars|length == 0 %}
  <div class="empty">
    <div class="empty__icon">üîé</div>
    <div class="empty__title">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>
    <div class="empty__text">–ü–æ–ø—Ä–æ–±—É–π –∏–∑–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã –∏–ª–∏ –∑–∞–ø—Ä–æ—Å –ø–æ–∏—Å–∫–∞.</div>
  </div>
  {% endif %}
</section>

<!-- –ú–∞—Ä—à—Ä—É—Ç—ã -->
<div id="routes"
     data-index-url="{{ url_for('index') }}"
     data-export-url="{{ url_for('export') }}"
     data-api-search-url=""
     hidden></div>

<!-- –î–∞–Ω–Ω—ã–µ –¥–ª—è –∑–∞–≤–∏—Å–∏–º—ã—Ö –º–æ–¥–µ–ª–µ–π -->
<div id="appData"
     data-models-by-brand="{{ models_by_brand_json|e }}"
     data-all-models="{{ models_json|e }}"
     data-saved-model="{{ saved_model_json|e }}"
     hidden></div>

<script>
  const routes = document.getElementById("routes").dataset;
  const INDEX_URL = routes.indexUrl;
  const EXPORT_URL = routes.exportUrl;
  const API_SEARCH_URL = routes.apiSearchUrl;

  const dataEl = document.getElementById("appData");
  const modelsByBrand = JSON.parse(dataEl.dataset.modelsByBrand);
  const allModels = JSON.parse(dataEl.dataset.allModels);
  const savedModel = JSON.parse(dataEl.dataset.savedModel);

  const form = document.getElementById("filterForm");
  const brandSelect = document.getElementById("brandSelect");
  const modelSelect = document.getElementById("modelSelect");
  const resetBtn = document.getElementById("resetBtn");
  const exportLink = document.getElementById("exportLink");

  function fillModels(models, selectedValue) {
    modelSelect.innerHTML = `<option value="">–õ—é–±–∞—è</option>`;
    models.forEach(m => {
      const opt = document.createElement("option");
      opt.value = m;
      opt.textContent = m;
      if (selectedValue && selectedValue === m) opt.selected = true;
      modelSelect.appendChild(opt);
    });
  }

  function initModels() {
    const brand = brandSelect.value;
    if (!brand) {
      fillModels(allModels, savedModel);
      return;
    }
    const models = modelsByBrand[brand] || [];
    fillModels(models, models.includes(savedModel) ? savedModel : "");
  }

  initModels();

  brandSelect.addEventListener("change", () => {
    const models = modelsByBrand[brandSelect.value] || [];
    fillModels(models, "");
  });

  // –≠–∫—Å–ø–æ—Ä—Ç –ø–æ —Ç–µ–∫—É—â–∏–º —Ñ–∏–ª—å—Ç—Ä–∞–º (–∏–∑ URL)
  exportLink.href = EXPORT_URL + window.location.search;

  // –†–µ–∞–ª—å–Ω—ã–π —Å–±—Ä–æ—Å: –æ—á–∏—Å—Ç–∫–∞ –ø–æ–ª–µ–π + –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —á–∏—Å—Ç—ã–π "/"
  resetBtn.addEventListener("click", () => {
    form.querySelectorAll("input").forEach(inp => inp.value = "");
    form.querySelectorAll("select").forEach(sel => sel.value = "");
    fillModels(allModels, "");
    window.location.href = INDEX_URL;
  });

  // ---- –ñ–∏–≤—ã–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏ –ø–æ–∏—Å–∫–∞ ----
  const searchInput = document.getElementById("searchInput");
  const searchField = document.getElementById("searchField");
  const searchSuggest = document.getElementById("searchSuggest");
  const suggestList = document.getElementById("suggestList");
  const suggestClose = document.getElementById("suggestClose");

  let searchTimer = null;
  let lastQuery = "";

  function hideSuggest() {
    searchSuggest.hidden = true;
    suggestList.innerHTML = "";
  }

  function showSuggest() {
    searchSuggest.hidden = false;
  }

  // –ß—Ç–æ–±—ã Enter –Ω–µ ‚Äú–ø–µ—Ä–µ–≤–æ–¥–∏–ª‚Äù –Ω–∞ –Ω–æ–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤–æ –≤—Ä–µ–º—è –Ω–∞–±–æ—Ä–∞
  searchInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter") e.preventDefault();
    if (e.key === "Escape") hideSuggest();
  });

  suggestClose.addEventListener("click", hideSuggest);

  document.addEventListener("click", (e) => {
    if (!searchField.contains(e.target)) hideSuggest();
  });

  async function fetchSuggest(q) {
    const brand = brandSelect.value || "";
    const url = `${API_SEARCH_URL}?q=${encodeURIComponent(q)}&brand=${encodeURIComponent(brand)}&limit=8`;
    const res = await fetch(url, { headers: { "Accept": "application/json" } });
    if (!res.ok) return [];
    return await res.json();
  }

  function renderSuggest(items) {
    if (!items || items.length === 0) {
      suggestList.innerHTML = `<div class="suggest__empty">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>`;
      showSuggest();
      return;
    }

    suggestList.innerHTML = items.map(x => `
      <a class="suggest__item" href="${INDEX_URL}?brand=${encodeURIComponent(x.brand)}&model=${encodeURIComponent(x.model)}">
        <div class="suggest__main">
          <div class="suggest__title">${x.brand} ${x.model}</div>
          <div class="suggest__meta">${x.year} ‚Ä¢ ${x.body_type}</div>
        </div>
        <div class="suggest__price">${x.price_usd} $</div>
      </a>
    `).join("");

    showSuggest();
  }

  searchInput.addEventListener("input", () => {
    const q = (searchInput.value || "").trim();

    if (q.length < 2) {
      hideSuggest();
      lastQuery = q;
      return;
    }

    clearTimeout(searchTimer);
    searchTimer = setTimeout(async () => {
      try {
        lastQuery = q;
        suggestList.innerHTML = `<div class="suggest__loading">–ü–æ–∏—Å–∫...</div>`;
        showSuggest();

        const items = await fetchSuggest(q);
        if (lastQuery !== q) return;

        renderSuggest(items);
      } catch (err) {
        suggestList.innerHTML = `<div class="suggest__empty">–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞</div>`;
        showSuggest();
      }
    }, 250);
  });
</script>

{% endblock %}
